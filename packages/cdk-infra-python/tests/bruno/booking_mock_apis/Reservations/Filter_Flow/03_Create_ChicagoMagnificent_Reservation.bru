meta {
  name: Create Chicago Magnificent Mile Reservation
  type: http
  seq: 3
}

post {
  url: {{apiUrl}}/reservation
  body: json
  auth: none
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "BookingInfo": {
      "BookedBy": "Filter Test Chicago Magnificent",
      "BookingDate": "2025-05-20"
    },
    "Hotel": {
      "Id": 50006,
      "Code": "HCCM",
      "Name": "Chicago Magnificent Mile Hotel"
    },
    "RoomStay": {
      "CheckInDate": "2025-03-20",
      "CheckOutDate": "2025-03-25",
      "GuestCount": [
        {
          "NumGuests": 2
        }
      ],
      "NumRooms": 1,
      "Products": [
        {
          "Product": {
            "RoomCode": "B1K",
            "RoomName": "Club Level King"
          },
          "Price": {
            "Amount": 390.0
          }
        }
      ]
    },
    "Guests": [
      {
        "PersonName": {
          "GivenName": "Filter",
          "Surname": "ChicagoMile_{{testId}}"
        },
        "EmailAddress": [
          {
            "Type": "Primary",
            "Value": "filter_chicagomile_{{testId}}@example.com"
          }
        ],
        "ContactNumbers": [
          {
            "Number": "3125559876"
          }
        ]
      }
    ],
    "status": "Confirmed",
    "Currency": {
      "Code": "USD",
      "Name": "US Dollars",
      "Symbol": "$"
    },
    "RoomPrices": {
      "TotalPrice": {
        "Price": {
          "CurrencyCode": "USD",
          "TotalAmount": 1950.0,
          "TotalAmountIncludingTaxesFees": 2164.50
        }
      }
    }
  }
}

script:post-response {
  try {
    if (res.status === 200 && res.body.reservations && res.body.reservations[0]) {
      const confirmationNumber = res.body.reservations[0].CrsConfirmationNumber;
      bru.setEnvVar("chicagoMileConfirmationNumber", confirmationNumber);
      console.log(`✅ Stored Chicago Magnificent Mile confirmation number: ${confirmationNumber}`);
    }
  } catch (error) {
    console.log(`❌ Error processing response: ${error.message}`);
  }
}

tests {
  test("Status code is 200", function() {
    expect(res.status).to.equal(200);
  });
  
  test("Response includes a valid confirmation number", function() {
    expect(res.body).to.have.property("reservations");
    expect(res.body.reservations).to.be.an('array').that.is.not.empty;
    expect(res.body.reservations[0]).to.have.property("CrsConfirmationNumber");
  });
  
  test("Reservation status is correctly set to Confirmed", function() {
    expect(res.body.reservations[0].status).to.equal("Confirmed");
  });
}
