meta {
  name: Filter By Departure Range
  type: http
  seq: 8
}

get {
  url: {{apiUrl}}/reservation?departure=2025-03-20,2025-04-01
  body: none
  auth: none

headers {
  X-Api-Key: {{apiKey}}
}
}

params:query {
  departure: 2025-03-20,2025-04-01
}

script:pre-request {
  console.log(`Filtering reservations by departure date range: 2025-03-20 to 2025-04-01`);
  
  // Validate we have created reservations successfully
  if (!bru.getEnvVar("chicagoConfirmationNumber") || 
      !bru.getEnvVar("chicagoMileConfirmationNumber")) {
    console.warn("⚠️ Warning: Chicago confirmation numbers are missing. Run the creation requests first!");
  }
}

tests {
  test("Status code is 200", function() {
    expect(res.status).to.equal(200);
  });
  
  test("Response includes reservations with departure dates in the specified range", function() {
    expect(res.body).to.have.property("reservations");
    const reservations = res.body.reservations;
    expect(reservations).to.be.an('array');
    
    // Check that all returned reservations have departure dates within the range
    reservations.forEach(reservation => {
      const departureDate = reservation.RoomStay.CheckOutDate;
      expect(departureDate).to.be.a('string');
      
      // Check date is between 2025-03-20 and 2025-04-01 (inclusive)
      const date = new Date(departureDate);
      const start = new Date('2025-03-20');
      const end = new Date('2025-04-01');
      
      expect(date >= start && date <= end).to.be.true;
    });
  });
  
  test("Chicago Regency reservation is included", function() {
    const chicagoConfirmation = bru.getEnvVar("chicagoConfirmationNumber");
    const confirmationNumbers = res.body.reservations.map(r => r.CrsConfirmationNumber);
    expect(confirmationNumbers).to.include(chicagoConfirmation);
  });
  
  test("Chicago Magnificent Mile reservation is included", function() {
    const chicagoMileConfirmation = bru.getEnvVar("chicagoMileConfirmationNumber");
    const confirmationNumbers = res.body.reservations.map(r => r.CrsConfirmationNumber);
    expect(confirmationNumbers).to.include(chicagoMileConfirmation);
  });
  
  test("Mountain View reservation (April 15 departure) is NOT included", function() {
    const mvConfirmation = bru.getEnvVar("mvConfirmationNumber");
    const confirmationNumbers = res.body.reservations.map(r => r.CrsConfirmationNumber);
    expect(confirmationNumbers).to.not.include(mvConfirmation);
  });
}
