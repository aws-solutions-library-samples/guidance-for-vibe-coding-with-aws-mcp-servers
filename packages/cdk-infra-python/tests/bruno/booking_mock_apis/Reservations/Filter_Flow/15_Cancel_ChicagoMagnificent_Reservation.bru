meta {
  name: Cancel Chicago Magnificent Mile Reservation
  type: http
  seq: 15
}

post {
  url: {{apiUrl}}/reservation/cancel
  body: json
  auth: none
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "Hotel": {
      "Id": 50006,
      "Code": "HCCM",
      "Name": "Chicago Magnificent Mile Hotel"
    },
    "CrsConfirmationNumber": "{{chicagoMileConfirmationNumber}}",
    "CancellationDetails": {
      "Comment": "Cancelling test reservation via Filter Flow"
    }
  }
}

script:pre-request {
  console.log(`Cancelling Chicago Magnificent Mile reservation: ${bru.getEnvVar("chicagoMileConfirmationNumber")}`);
  
  // Validate we have created the reservation successfully
  if (!bru.getEnvVar("chicagoMileConfirmationNumber")) {
    console.error("❌ Chicago Magnificent Mile confirmation number is missing! Run the creation request first!");
  }
}

script:post-response {
  // Store cancellation number if successful
  try {
    if (res.status === 200 && res.body && res.body.CrsCancellationNumber) {
      bru.setEnvVar("chicagoMileCancellationNumber", res.body.CrsCancellationNumber);
      console.log(`✅ Stored Chicago Magnificent Mile cancellation number: ${res.body.CrsCancellationNumber}`);
    }
  } catch (error) {
    console.log(`❌ Error processing response: ${error.message}`);
  }
}

tests {
  test("Status code is 200", function() {
    expect(res.status).to.equal(200);
  });
  
  test("Response includes a cancellation number", function() {
    expect(res.body).to.have.property("CrsCancellationNumber");
    expect(res.body.CrsCancellationNumber).to.be.a('string').that.includes("X");
  });
  
  test("Cancellation number has expected format", function() {
    // Should be the hotel ID (50006) followed by X and some digits
    const cancellationNumber = res.body.CrsCancellationNumber;
    expect(cancellationNumber).to.match(/^50006X\d+$/);
  });
}
