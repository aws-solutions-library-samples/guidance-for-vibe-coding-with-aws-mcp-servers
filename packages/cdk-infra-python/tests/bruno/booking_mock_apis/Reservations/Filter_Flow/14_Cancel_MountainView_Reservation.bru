meta {
  name: Cancel Mountain View Reservation
  type: http
  seq: 14
}

post {
  url: {{apiUrl}}/reservation/cancel
  body: json
  auth: none
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "Hotel": {
      "Id": 50002,
      "Code": "HCMV",
      "Name": "Mountain View Hotel"
    },
    "CrsConfirmationNumber": "{{mvConfirmationNumber}}",
    "CancellationDetails": {
      "Comment": "Cancelling test reservation via Filter Flow"
    }
  }
}

script:pre-request {
  console.log(`Cancelling Mountain View reservation: ${bru.getEnvVar("mvConfirmationNumber")}`);
  
  // Validate we have created the reservation successfully
  if (!bru.getEnvVar("mvConfirmationNumber")) {
    console.error("❌ Mountain View confirmation number is missing! Run the creation request first!");
  }
}

script:post-response {
  // Store cancellation number if successful
  try {
    if (res.status === 200 && res.body && res.body.CrsCancellationNumber) {
      bru.setEnvVar("mvCancellationNumber", res.body.CrsCancellationNumber);
      console.log(`✅ Stored Mountain View cancellation number: ${res.body.CrsCancellationNumber}`);
    }
  } catch (error) {
    console.log(`❌ Error processing response: ${error.message}`);
  }
}

tests {
  test("Status code is 200", function() {
    expect(res.status).to.equal(200);
  });
  
  test("Response includes a cancellation number", function() {
    expect(res.body).to.have.property("CrsCancellationNumber");
    expect(res.body.CrsCancellationNumber).to.be.a('string').that.includes("X");
  });
}
