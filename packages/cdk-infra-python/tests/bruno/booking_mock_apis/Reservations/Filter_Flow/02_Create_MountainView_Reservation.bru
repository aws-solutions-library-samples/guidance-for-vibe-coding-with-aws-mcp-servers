meta {
  name: Create Mountain View Reservation
  type: http
  seq: 2
}

post {
  url: {{apiUrl}}/reservation
  body: json
  auth: none
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "BookingInfo": {
      "BookedBy": "Filter Test MountainView",
      "BookingDate": "2025-05-20"
    },
    "Hotel": {
      "Id": 50002,
      "Code": "HCMV",
      "Name": "Mountain View Hotel"
    },
    "RoomStay": {
      "CheckInDate": "2025-04-10",
      "CheckOutDate": "2025-04-15",
      "GuestCount": [
        {
          "NumGuests": 3
        }
      ],
      "NumRooms": 1,
      "Products": [
        {
          "Product": {
            "RoomCode": "A2Q",
            "RoomName": "Standard Double Queen"
          },
          "Price": {
            "Amount": 280.0
          }
        }
      ]
    },
    "Guests": [
      {
        "PersonName": {
          "GivenName": "Filter",
          "Surname": "MountainView_{{testId}}"
        },
        "EmailAddress": [
          {
            "Type": "Primary",
            "Value": "filter_mv_{{testId}}@example.com"
          }
        ],
        "ContactNumbers": [
          {
            "Number": "6505551234"
          }
        ]
      }
    ],
    "status": "Booked",
    "Currency": {
      "Code": "USD",
      "Name": "US Dollars",
      "Symbol": "$"
    },
    "RoomPrices": {
      "TotalPrice": {
        "Price": {
          "CurrencyCode": "USD",
          "TotalAmount": 1400.0,
          "TotalAmountIncludingTaxesFees": 1554.0
        }
      }
    }
  }
}

script:post-response {
  try {
    if (res.status === 200 && res.body.reservations && res.body.reservations[0]) {
      const confirmationNumber = res.body.reservations[0].CrsConfirmationNumber;
      bru.setEnvVar("mvConfirmationNumber", confirmationNumber);
      console.log(`✅ Stored Mountain View confirmation number: ${confirmationNumber}`);
    }
  } catch (error) {
    console.log(`❌ Error processing response: ${error.message}`);
  }
}

tests {
  test("Status code is 200", function() {
    expect(res.status).to.equal(200);
  });
  
  test("Response includes a valid confirmation number", function() {
    expect(res.body).to.have.property("reservations");
    expect(res.body.reservations).to.be.an('array').that.is.not.empty;
    expect(res.body.reservations[0]).to.have.property("CrsConfirmationNumber");
  });
  
  test("Reservation status is correctly set to Booked", function() {
    expect(res.body.reservations[0].status).to.equal("Booked");
  });
}
