meta {
  name: Combined Filters Test
  type: http
  seq: 11
}

get {
  url: {{apiUrl}}/reservation?status=Confirmed&arrival=2025-03-15,2025-03-16
  body: none
  auth: none

headers {
  X-Api-Key: {{apiKey}}
}
}

params:query {
  status: Confirmed
  arrival: 2025-03-15,2025-03-16
}

script:pre-request {
  console.log(`Testing combined filters: status=Confirmed and arrival date range 2025-03-15 to 2025-03-16`);
  
  // Validate we have created reservations successfully
  if (!bru.getEnvVar("chicagoConfirmationNumber") || 
      !bru.getEnvVar("chicagoMileConfirmationNumber")) {
    console.warn("⚠️ Warning: Chicago confirmation numbers are missing. Run the creation requests first!");
  }
}

tests {
  test("Status code is 200", function() {
    expect(res.status).to.equal(200);
  });
  
  test("Response includes reservations array", function() {
    expect(res.body).to.have.property("reservations");
    expect(res.body.reservations).to.be.an('array');
  });
  
  test("Only the Chicago Regency reservation is included", function() {
    // Should only return Chicago Regency (arrives on 2025-03-15)
    // The Chicago Magnificent Mile reservation arrives on 2025-03-20, outside our range
    const reservations = res.body.reservations;
    expect(reservations.length).to.equal(1);
    
    const chicagoConfirmation = bru.getEnvVar("chicagoConfirmationNumber");
    expect(reservations[0].CrsConfirmationNumber).to.equal(chicagoConfirmation);
  });
  
  test("Returned reservation has expected values", function() {
    const reservation = res.body.reservations[0];
    
    // Check status filter worked
    expect(reservation.status).to.equal("Confirmed");
    
    // Check arrival date filter worked
    expect(reservation.RoomStay.CheckInDate).to.equal("2025-03-15");
    
    // Additional reservation details
    expect(reservation.Hotel.Id).to.equal(50005);
  });
  
  test("Chicago Magnificent Mile and Mountain View reservations are NOT included", function() {
    const chicagoMileConfirmation = bru.getEnvVar("chicagoMileConfirmationNumber");
    const mvConfirmation = bru.getEnvVar("mvConfirmationNumber");
    
    const confirmationNumbers = res.body.reservations.map(r => r.CrsConfirmationNumber);
    expect(confirmationNumbers).to.not.include(chicagoMileConfirmation);
    expect(confirmationNumbers).to.not.include(mvConfirmation);
  });
}
