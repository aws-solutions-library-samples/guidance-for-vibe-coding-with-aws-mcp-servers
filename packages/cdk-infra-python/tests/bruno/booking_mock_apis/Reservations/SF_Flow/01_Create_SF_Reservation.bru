meta {
  name: Create San Francisco Reservation
  type: http
  seq: 1
}

post {
  url: {{apiUrl}}/reservation
  body: json
  auth: none
}

headers {
  X-Api-Key: {{apiKey}}
}

body:json {
  {
    "BookingInfo": {
      "BookedBy": "{{sfGuest.PersonName.GivenName}} {{sfGuest.PersonName.Surname}}",
      "BookingDate": "2025-05-20"
    },
    "Hotel": {
      "Id": {{sfHotel.Id}},
      "Code": "{{sfHotel.Code}}",
      "Name": "{{sfHotel.Name}}"
    },
    "RoomStay": {
      "CheckInDate": "2025-06-15",
      "CheckOutDate": "2025-06-20",
      "GuestCount": [
        {
          "NumGuests": 2
        }
      ],
      "NumRooms": 1,
      "Products": [
        {
          "Product": {
            "RoomCode": "{{kingRoom.RoomCode}}",
            "RoomName": "{{kingRoom.RoomName}}"
          },
          "Price": {
            "Amount": 350.0
          }
        }
      ]
    },
    "Guests": [
      {
        "PersonName": {
          "GivenName": "{{sfGuest.PersonName.GivenName}}",
          "Surname": "{{sfGuest.PersonName.Surname}}"
        },
        "EmailAddress": [
          {
            "Type": "{{sfGuest.EmailAddress.0.Type}}",
            "Value": "{{sfGuest.EmailAddress.0.Value}}"
          }
        ],
        "ContactNumbers": [
          {
            "Number": "{{sfGuest.ContactNumbers.0.Number}}"
          }
        ]
      }
    ],
    "status": "Confirmed",
    "Currency": {
      "Code": "USD",
      "Name": "US Dollars",
      "Symbol": "$"
    },
    "RoomPrices": {
      "TotalPrice": {
        "Price": {
          "CurrencyCode": "USD",
          "TotalAmount": 1750.0,
          "TotalAmountIncludingTaxesFees": 1942.50
        }
      }
    }
  }
}

script:post-response {
  try {
    if (res.status === 200 && res.body.reservations && res.body.reservations[0]) {
      const confirmationNumber = res.body.reservations[0].CrsConfirmationNumber;
      bru.setEnvVar("sfConfirmationNumber", confirmationNumber);
      console.log(`✅ Stored SF confirmation number: ${confirmationNumber}`);
    }
  } catch (error) {
    console.log(`❌ Error processing response: ${error.message}`);
  }
}

tests {
  test("Status code is 200", function() {
    expect(res.status).to.equal(200);
  });
  
  test("Response includes a valid confirmation number", function() {
    expect(res.body).to.have.property("reservations");
    expect(res.body.reservations).to.be.an('array').that.is.not.empty;
    expect(res.body.reservations[0]).to.have.property("CrsConfirmationNumber");
  });
}
