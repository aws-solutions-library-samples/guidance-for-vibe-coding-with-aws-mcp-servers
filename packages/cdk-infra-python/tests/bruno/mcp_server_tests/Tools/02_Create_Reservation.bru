meta {
  name: Create Reservation via MCP Server
  type: http
  seq: 2
}

post {
  url: {{mcpServerUrl}}
  body: json
  auth: none
}

headers {
  Authorization: Bearer {{bearerToken}}
  Content-Type: application/json
  Accept: application/json, text/event-stream
}

body:json {
  {
    "jsonrpc": "2.0",
    "id": 2,
    "method": "tools/call",
    "params": {
      "name": "create_reservation",
      "arguments": {
        "hotel_id": "{{sfHotel.Id}}",
        "room_type": "{{kingRoom.Code}}",
        "check_in_date": "{{checkInDate}}",
        "check_out_date": "{{checkOutDate}}",
        "guest_name": "{{testGuest.Name}}",
        "guest_email": "{{testGuest.Email}}",
        "guests": {{guests}}
      }
    }
  }
}

tests {
  test("Status code is 200", function() {
    expect(res.status).to.equal(200);
  });
  
  test("Response contains MCP result", function() {
    // Parse SSE response format
    let responseData;
    if (typeof res.body === 'string') {
      // Extract JSON from SSE format
      const lines = res.body.split('\n');
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const jsonData = line.replace('data: ', '');
          responseData = JSON.parse(jsonData);
          break;
        }
      }
    } else {
      responseData = res.body;
    }
    
    expect(responseData).to.be.an("object");
    expect(responseData).to.have.property("result");
  });
  
  test("Response indicates successful tool execution", function() {
    // Parse SSE response format
    let responseData;
    if (typeof res.body === 'string') {
      // Extract JSON from SSE format
      const lines = res.body.split('\n');
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const jsonData = line.replace('data: ', '');
          responseData = JSON.parse(jsonData);
          break;
        }
      }
    } else {
      responseData = res.body;
    }
    
    if (responseData && responseData.result) {
      expect(responseData.result).to.have.property("content");
      expect(responseData.result.content).to.be.an("array");
      expect(responseData.result.content.length).to.be.greaterThan(0);
    }
  });
  
  test("Response contains reservation data", function() {
    // Parse SSE response format
    let responseData;
    if (typeof res.body === 'string') {
      // Extract JSON from SSE format
      const lines = res.body.split('\n');
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const jsonData = line.replace('data: ', '');
          responseData = JSON.parse(jsonData);
          break;
        }
      }
    } else {
      responseData = res.body;
    }
    
    if (responseData && responseData.result && responseData.result.content && responseData.result.content[0] && responseData.result.content[0].text) {
      const responseText = responseData.result.content[0].text.toLowerCase();
      expect(responseText).to.satisfy(function(text) {
        return text.includes("reservation") || text.includes("booking") || text.includes("hotel");
      });
    }
  });
}

docs {
  Create Reservation via MCP Server
  
  This test calls the MCP server's create_reservation tool through AgentCore.
  
  Expected Behavior:
  - MCP server receives the prompt with reservation details
  - Parses the request to use create_reservation tool
  - Calls Reservation Services API with Bruno configuration
  - Returns reservation confirmation
  
  Test Parameters:
  - Hotel ID: {{sfHotel.Id}} (San Francisco Hotel)
  - Room Type: {{kingRoom.Code}} (Club Level King)
  - Check-in: {{checkInDate}}
  - Check-out: {{checkOutDate}}
  - Guest: {{testGuest.Name}} ({{testGuest.Email}})
  - Guests: {{guests}}
  
  Test Validation:
  - HTTP 200 response
  - Response contains reservation confirmation
  - Tool execution is successful
  - Hotel information is preserved in response
  
  Notes:
  - Uses AgentCore prompt-based invocation
  - Bearer token must be valid Cognito token
  - Reservation data follows Bruno test patterns
}
