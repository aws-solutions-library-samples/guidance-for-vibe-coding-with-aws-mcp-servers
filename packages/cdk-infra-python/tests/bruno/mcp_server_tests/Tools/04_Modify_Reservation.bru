meta {
  name: 04_Modify_Reservation
  type: http
  seq: 4
}

post {
  url: {{mcp_url}}
  body: json
  auth: bearer
}

auth:bearer {
  token: {{bearer_token}}
}

headers {
  Content-Type: application/json
  Accept: application/json, text/event-stream
}

body:json {
  {
    "jsonrpc": "2.0",
    "id": 4,
    "method": "tools/call",
    "params": {
      "name": "modify_reservation",
      "arguments": {
        "booking_id": "booking_001",
        "check_in_date": "2024-03-16",
        "check_out_date": "2024-03-18",
        "guests": 3,
        "special_requests": "Ocean view room preferred"
      }
    }
  }
}

tests {
  test("Status code is 200", function() {
    expect(res.getStatus()).to.equal(200);
  });

  test("Response contains event data", function() {
    const responseText = res.getBody();
    expect(responseText).to.contain("event: message");
    expect(responseText).to.contain("data: ");
  });

  test("MCP response is valid", function() {
    const responseText = res.getBody();
    
    // Extract JSON data from Server-Sent Events format
    let jsonData;
    if (responseText.includes("event: message\ndata: ")) {
      jsonData = responseText.replace(/.*event: message\ndata: /, "").trim();
    } else if (responseText.includes("data: ")) {
      const lines = responseText.split("\n");
      for (const line of lines) {
        if (line.startsWith("data: ")) {
          jsonData = line.replace("data: ", "");
          break;
        }
      }
    }
    
    expect(jsonData).to.be.a('string');
    
    const mcpResponse = JSON.parse(jsonData);
    expect(mcpResponse).to.have.property('jsonrpc', '2.0');
    expect(mcpResponse).to.have.property('id', 4);
    expect(mcpResponse).to.have.property('result');
    
    const result = mcpResponse.result;
    expect(result).to.have.property('content');
    expect(result.content).to.be.an('array');
    expect(result.content.length).to.be.greaterThan(0);
    
    const content = result.content[0];
    expect(content).to.have.property('type', 'text');
    expect(content).to.have.property('text');
    
    const toolResponse = JSON.parse(content.text);
    expect(toolResponse).to.have.property('status');
    
    // Tool should work (success or API error is acceptable)
    const validStatuses = ['success', 'error'];
    expect(validStatuses).to.include(toolResponse.status);
    
    if (toolResponse.status === 'success') {
      expect(toolResponse).to.have.property('message');
      expect(toolResponse).to.have.property('booking_id', 'booking_001');
    } else if (toolResponse.status === 'error') {
      expect(toolResponse).to.have.property('message');
    }
  });

  test("Tool execution completed", function() {
    // This test passes if we reach here without errors
    expect(true).to.equal(true);
  });
}
