meta {
  name: Search Properties via MCP Server
  type: http
  seq: 1
}

post {
  url: {{mcpServerUrl}}
  body: json
  auth: none
}

headers {
  Authorization: Bearer {{bearerToken}}
  Content-Type: application/json
  Accept: application/json, text/event-stream
}

body:json {
  {
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
      "name": "search_properties",
      "arguments": {
        "location": "san francisco",
        "check_in_date": "{{checkInDate}}",
        "check_out_date": "{{checkOutDate}}",
        "guests": {{guests}}
      }
    }
  }
}

tests {
  test("Status code is 200", function() {
    expect(res.status).to.equal(200);
  });
  
  test("Response contains MCP result", function() {
    // Parse SSE response format
    let responseData;
    if (typeof res.body === 'string') {
      // Extract JSON from SSE format
      const lines = res.body.split('\n');
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const jsonData = line.replace('data: ', '');
          responseData = JSON.parse(jsonData);
          break;
        }
      }
    } else {
      responseData = res.body;
    }
    
    expect(responseData).to.be.an("object");
    expect(responseData).to.have.property("result");
  });
  
  test("Response indicates successful tool execution", function() {
    // Parse SSE response format
    let responseData;
    if (typeof res.body === 'string') {
      // Extract JSON from SSE format
      const lines = res.body.split('\n');
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const jsonData = line.replace('data: ', '');
          responseData = JSON.parse(jsonData);
          break;
        }
      }
    } else {
      responseData = res.body;
    }
    
    if (responseData && responseData.result) {
      expect(responseData.result).to.have.property("content");
      expect(responseData.result.content).to.be.an("array");
      expect(responseData.result.content.length).to.be.greaterThan(0);
    }
  });
}

docs {
  Search Properties via MCP Server
  
  This test calls the MCP server's search_properties tool through AgentCore.
  
  Expected Behavior:
  - MCP server receives the prompt
  - Parses the request to use search_properties tool
  - Calls Property Resolution API with Bruno configuration
  - Returns hotel search results
  
  Test Validation:
  - HTTP 200 response
  - Response contains search results
  - Tool execution is successful
  
  Notes:
  - Uses AgentCore prompt-based invocation
  - Bearer token must be valid Cognito token
  - MCP server URL must be correctly encoded ARN
}
